---
phase: 04-device-detection-middleware
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/constants/bots.ts
  - src/middleware.ts
autonomous: true
requirements:
  - RDIR-01
  - RDIR-02
  - RDIR-03
  - RDIR-04
  - RDIR-05

must_haves:
  truths:
    - "iOS phone user visiting /download gets a 307 redirect to the App Store URL"
    - "Android phone user visiting /download gets a 307 redirect to the Google Play URL"
    - "Googlebot visiting /download passes through to the fallback page (no redirect)"
    - "Social media crawlers (Slack, Facebook, Twitter) visiting /download pass through (no redirect)"
    - "iPadOS user visiting /download sees the fallback page (no redirect)"
    - "Desktop user visiting /download sees the fallback page (no redirect)"
    - "Existing /truck/:path* mobile redirect logic continues to work unchanged"
  artifacts:
    - path: "src/constants/bots.ts"
      provides: "BOT_PATTERNS supplemental regex for crawler detection"
      exports: ["BOT_PATTERNS"]
    - path: "src/middleware.ts"
      provides: "Device detection and redirect logic for /download route"
      contains: "pathname === '/download'"
  key_links:
    - from: "src/middleware.ts"
      to: "src/constants/bots.ts"
      via: "import { BOT_PATTERNS }"
      pattern: "BOT_PATTERNS\\.test"
    - from: "src/middleware.ts"
      to: "src/constants/links.ts"
      via: "import { APP_STORE_LINK, GOOGLE_PLAY_LINK }"
      pattern: "NextResponse\\.redirect\\(APP_STORE_LINK"
    - from: "src/middleware.ts"
      to: "next/server"
      via: "import { userAgent }"
      pattern: "userAgent\\(request\\)"
---

<objective>
Create the /download route middleware that auto-redirects iOS phone users to the App Store and Android phone users to Google Play via 307 temporary redirects, while allowing bots, crawlers, desktop users, and iPadOS users to pass through to the fallback page.

Purpose: Mobile users get instant app store redirect without seeing any intermediate page content. Search engines and social media crawlers see the HTML page for indexing and link previews. Desktop and unknown devices see the fallback page with both store options.

Output: `src/constants/bots.ts` (new) and updated `src/middleware.ts` with /download detection block.
</objective>

<execution_context>
@/Users/jacobfinn/.claude/get-shit-done/workflows/execute-plan.md
@/Users/jacobfinn/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-device-detection-middleware/04-RESEARCH.md

@src/middleware.ts
@src/constants/links.ts

<interfaces>
<!-- Key types and contracts the executor needs. Extracted from codebase. -->

From src/constants/links.ts:
```typescript
export const APP_STORE_LINK = "https://apps.apple.com/us/app/streetfeast/id6749815073";
export const GOOGLE_PLAY_LINK = "https://play.google.com/store/apps/details?id=com.streetfeast.streetfeast";
```

From next/server (userAgent helper return shape):
```typescript
// import { NextRequest, NextResponse, userAgent } from 'next/server';
const { isBot, device, browser, os } = userAgent(request);
// device.type: 'mobile' | 'tablet' | 'console' | 'smarttv' | 'wearable' | 'embedded' | undefined
// isBot: boolean — true for known bots
// undefined device.type = desktop or iPadOS (both go to fallback)
```

Existing src/middleware.ts structure:
```typescript
// Currently handles /truck/:path* mobile redirect
// Uses raw regex: /iPhone|iPad|iPod|Android/i.test(userAgent)
// matcher: ['/truck/:path*']
// Must preserve this existing behavior unchanged
```
</interfaces>
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create bot patterns constants file</name>
  <files>src/constants/bots.ts</files>
  <action>
Create `src/constants/bots.ts` exporting a single `BOT_PATTERNS` RegExp constant.

This supplements the built-in `isBot` from `next/server`'s `userAgent()` helper, covering confirmed gaps (Next.js GitHub issue #75032) and social media link preview crawlers.

The regex must include (case-insensitive):
- Google gaps: `Google-InspectionTool`, `Google-CloudVertexBot`, `Google-Other`
- Social crawlers: `facebookexternalhit`, `facebookcatalog`, `Twitterbot`, `LinkedInBot`, `Slackbot`, `Discordbot`, `WhatsApp`, `TelegramBot`
- Apple: `Applebot`
- Other preview bots: `SkypeUriPreview`, `redditbot`, `vkShare`, `bitlybot`
- General: `ia_archiver`, `Mediapartners-Google`

Export as a compiled RegExp with the `i` flag. Add a JSDoc comment explaining this supplements the built-in `isBot` and referencing the GitHub issue.

IMPORTANT: This file must be Edge Runtime compatible — pure RegExp export only, no Node.js API usage.
  </action>
  <verify>
    <automated>cd /Users/jacobfinn/Desktop/Projects/streetfeast-website-fe && test -f src/constants/bots.ts && node -e "const m = require('fs').readFileSync('src/constants/bots.ts','utf8'); if(!m.includes('BOT_PATTERNS') || !m.includes('export')) { process.exit(1); }" && echo "PASS"</automated>
  </verify>
  <done>src/constants/bots.ts exists, exports BOT_PATTERNS as a case-insensitive RegExp covering Google inspection bots and social media crawlers</done>
</task>

<task type="auto">
  <name>Task 2: Add /download device detection and redirect to middleware</name>
  <files>src/middleware.ts</files>
  <action>
Update the existing `src/middleware.ts` to add /download route handling. The existing /truck logic must remain unchanged.

**Imports to add:**
- `userAgent` from `'next/server'` (add to existing import line)
- `APP_STORE_LINK`, `GOOGLE_PLAY_LINK` from `'@/constants/links'`
- `BOT_PATTERNS` from `'@/constants/bots'`

**Matcher update:**
Add `'/download'` (exact match, NO `:path*` suffix) to the existing `config.matcher` array alongside `'/truck/:path*'`.

**Detection logic — add AFTER the existing /truck block, BEFORE the final `return NextResponse.next()`:**

```
if (pathname === '/download') {
  const ua = request.headers.get('user-agent') || '';
  const { isBot: detectedBot, device } = userAgent(request);

  // 1. Bot check FIRST — bots always see the page (locked decision)
  if (detectedBot || BOT_PATTERNS.test(ua)) {
    return NextResponse.next();
  }

  // 2. iOS phone (iPhone, iPod Touch) -> App Store
  if (device.type === 'mobile' && /iPhone|iPod/i.test(ua)) {
    return NextResponse.redirect(APP_STORE_LINK, 307);
  }

  // 3. Android phone -> Google Play
  if (device.type === 'mobile' && /Android/i.test(ua)) {
    return NextResponse.redirect(GOOGLE_PLAY_LINK, 307);
  }

  // 4. Desktop, iPadOS, Android tablet, unknown -> fallback page
  return NextResponse.next();
}
```

**Critical implementation notes:**
- Use `device.type === 'mobile'` as primary check — this excludes tablets (device.type === 'tablet') and iPadOS (device.type === undefined)
- The secondary regex (`/iPhone|iPod/i` and `/Android/i`) adds specificity so the correct store is chosen
- Do NOT include `iPad` in any redirect condition — iPadOS 13+ sends a Macintosh UA and device.type is undefined, so it naturally falls to the fallback path (this is the accepted limitation per RDIR-04)
- Do NOT use `device.type === 'mobile'` alone without the secondary UA check — the secondary check determines which store
- Use 307 (temporary redirect), NEVER 301/308
- Bot check runs BEFORE device check — even mobile-class bots like Googlebot-Mobile must see the page
- The existing /truck redirect logic uses a raw UA regex and does NOT use the `userAgent()` helper — leave it as-is to avoid regressions

**Existing /truck logic — DO NOT MODIFY:**
The current /truck block uses `const userAgent = request.headers.get('user-agent') || ''` as a variable name. When adding the `userAgent` import from `next/server`, rename the local variable to avoid shadowing (e.g., `const ua = request.headers.get('user-agent') || ''` at the top of the function, then reference `ua` in both the /truck block and the /download block).
  </action>
  <verify>
    <automated>cd /Users/jacobfinn/Desktop/Projects/streetfeast-website-fe && npm run lint && npm run build</automated>
  </verify>
  <done>
- Middleware compiles and builds without errors
- /download is in the matcher config
- Bot check (isBot + BOT_PATTERNS) runs before device detection
- iOS phone detection uses device.type === 'mobile' && /iPhone|iPod/i and redirects to APP_STORE_LINK with 307
- Android phone detection uses device.type === 'mobile' && /Android/i and redirects to GOOGLE_PLAY_LINK with 307
- All other requests (desktop, iPadOS, tablets, unknown) pass through via NextResponse.next()
- Existing /truck redirect logic still works unchanged
  </done>
</task>

</tasks>

<verification>
1. `npm run lint` passes with no errors
2. `npm run build` succeeds (confirms Edge Runtime compatibility of all imports)
3. `src/constants/bots.ts` exists and exports `BOT_PATTERNS` RegExp
4. `src/middleware.ts` matcher includes both `'/truck/:path*'` and `'/download'`
5. `/download` block checks `isBot || BOT_PATTERNS.test(ua)` before any device redirect
6. iOS redirect uses `NextResponse.redirect(APP_STORE_LINK, 307)`
7. Android redirect uses `NextResponse.redirect(GOOGLE_PLAY_LINK, 307)`
8. No `iPad` string appears in redirect conditions
9. Existing `/truck` redirect logic is preserved
</verification>

<success_criteria>
- Build succeeds with zero lint errors
- middleware.ts handles /download with bot-first detection, iOS 307 redirect, Android 307 redirect, and desktop/unknown fallthrough
- constants/bots.ts provides supplemental bot patterns as a single exported RegExp
- Existing /truck mobile redirect behavior is unchanged
</success_criteria>

<output>
After completion, create `.planning/phases/04-device-detection-middleware/04-01-SUMMARY.md`
</output>
