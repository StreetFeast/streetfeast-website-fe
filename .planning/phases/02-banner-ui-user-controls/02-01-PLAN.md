---
phase: 02-banner-ui-user-controls
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/components/CookieBanner/CookieBanner.tsx
  - src/components/CookieBanner/CookieBanner.module.css
  - src/components/CookieBanner/index.ts
  - src/app/layout.tsx
  - src/components/Footer/CookiePrefsButton.tsx
  - src/components/Footer/Footer.tsx
  - src/components/Footer/Footer.module.css
autonomous: true

must_haves:
  truths:
    - "User sees a bottom-bar cookie banner on first visit when consent is undecided (hasConsented === null)"
    - "User can click Accept All to set consent to true or Reject All to set consent to false"
    - "Accept All and Reject All buttons have identical visual styling (same size, color, weight, position)"
    - "User can navigate the banner with keyboard only (Tab between buttons, Enter to activate, Escape to dismiss)"
    - "Banner text explains reCAPTCHA and FingerprintJS are used for spam prevention in clear plain language"
    - "User can click Cookie Preferences in the footer to reset consent and make the banner reappear"
    - "Banner is responsive on mobile (stacks vertically at 640px breakpoint) without obscuring primary content"
    - "All text meets WCAG 2.2 AA contrast (4.5:1 minimum): dark text on orange buttons, light text on dark banner)"
  artifacts:
    - path: "src/components/CookieBanner/CookieBanner.tsx"
      provides: "Cookie consent banner component with hydration guard, focus management, scroll-padding, and Escape key handling"
      contains: "useConsentStore"
    - path: "src/components/CookieBanner/CookieBanner.module.css"
      provides: "Fixed bottom-bar styling with WCAG-compliant colors and responsive breakpoint"
      contains: ".banner"
    - path: "src/components/CookieBanner/index.ts"
      provides: "Re-export for clean imports"
      contains: "export"
    - path: "src/components/Footer/CookiePrefsButton.tsx"
      provides: "Client component that calls clearConsent to reopen banner"
      contains: "clearConsent"
    - path: "src/components/Footer/Footer.tsx"
      provides: "Footer with Cookie Preferences link in Legal column"
      contains: "CookiePrefsButton"
    - path: "src/app/layout.tsx"
      provides: "Root layout rendering CookieBanner in body"
      contains: "CookieBanner"
  key_links:
    - from: "src/components/CookieBanner/CookieBanner.tsx"
      to: "src/store/consentStore.ts"
      via: "useConsentStore hook"
      pattern: "useConsentStore"
    - from: "src/components/Footer/CookiePrefsButton.tsx"
      to: "src/store/consentStore.ts"
      via: "useConsentStore hook calling clearConsent"
      pattern: "clearConsent"
    - from: "src/app/layout.tsx"
      to: "src/components/CookieBanner/CookieBanner.tsx"
      via: "import and render in body"
      pattern: "<CookieBanner"
    - from: "src/components/Footer/Footer.tsx"
      to: "src/components/Footer/CookiePrefsButton.tsx"
      via: "import and render in Legal column"
      pattern: "<CookiePrefsButton"
---

<objective>
Create the cookie consent banner component and footer re-consent link for WCAG 2.2 AA compliant cookie consent UX.

Purpose: Users need to see a consent banner on first visit, make an informed accept/reject choice, and be able to change their mind later via the footer. This satisfies BNRR-02, BNRR-03, BNRR-04, BNRR-06, BNRR-07, and all A11Y requirements. Note: BNRR-01 ("banner appears before any non-essential scripts load") is split across phases — Phase 2 delivers the banner UI; Phase 3 delivers the "before scripts load" enforcement via conditional script loading.

Output: CookieBanner component rendered in root layout, CookiePrefsButton in footer Legal column, full keyboard navigation, WCAG contrast compliance.
</objective>

<execution_context>
@/Users/zachshearer/.claude/get-shit-done/workflows/execute-plan.md
@/Users/zachshearer/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-banner-ui-user-controls/02-RESEARCH.md
@.planning/phases/01-state-management-foundation/01-01-SUMMARY.md
@src/store/consentStore.ts
@src/app/layout.tsx
@src/components/Footer/Footer.tsx
@src/components/Footer/Footer.module.css
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create CookieBanner component and render in root layout</name>
  <files>
    src/components/CookieBanner/CookieBanner.tsx
    src/components/CookieBanner/CookieBanner.module.css
    src/components/CookieBanner/index.ts
    src/app/layout.tsx
  </files>
  <action>
Create the CookieBanner component following the project's component folder convention (ComponentName/ComponentName.tsx + .module.css + index.ts).

**CookieBanner.tsx** — Client component (`'use client'`):
- Import `useConsentStore` from `@/store/consentStore` and destructure `hasConsented`, `isHydrated`, `setConsent`
- Import `useEffect`, `useRef`, `useCallback`, `useState` from React
- Import styles from `./CookieBanner.module.css`
- **Local state:** `const [dismissed, setDismissed] = useState(false)` — tracks Escape-key dismissal for this session only
- **Hydration guard (React Rules of Hooks — critical):** Call ALL hooks unconditionally at the top of the component (useState, useRef, useEffect, useCallback — every one). Compute `const shouldShow = isHydrated && hasConsented === null && !dismissed`. Return `null` if `!shouldShow` — this goes AFTER all hook calls, at the JSX return level. Inside each `useEffect`, gate side-effects with `if (!shouldShow) return;` so they no-op when the banner is hidden. Do NOT place an early `return null` before any hook call — that violates React's Rules of Hooks and will crash on re-render.
- **Refs:** `bannerRef` for the banner div (ResizeObserver), `acceptButtonRef` for first button (focus on mount)
- **Focus on mount effect:** When the banner is visible (shouldShow is true), call `acceptButtonRef.current?.focus()` — this announces the banner to screen readers per WCAG 2.4.3. Gate this effect on `shouldShow` so it only runs when the banner appears.
- **scroll-padding-bottom effect (WCAG 2.4.11):** When banner is visible, create a `ResizeObserver` on `bannerRef.current` that sets `document.documentElement.style.setProperty('scroll-padding-bottom', \`${el.offsetHeight + 8}px\`)`. On cleanup (banner dismissed or unmount), call `observer.disconnect()` and `document.documentElement.style.removeProperty('scroll-padding-bottom')`. Gate on `shouldShow`.
- **Escape key effect:** Add a `keydown` listener on `document`; when `Escape` is pressed, set `dismissed = true` (local state only) — do NOT call `setConsent`. This hides the banner for the current page session but leaves `hasConsented === null`, so the banner returns on next page load. Clean up the keydown listener on unmount.
- **ARIA:** The banner div gets `role="dialog"`, `aria-modal="false"` (non-modal, non-blocking), `aria-labelledby="cookie-banner-title"`, `aria-describedby="cookie-banner-desc"`
- **JSX structure:**
  - Outer div: `ref={bannerRef}`, role/aria attrs, `className={styles.banner}`
  - Content div (`styles.content`):
    - `<p id="cookie-banner-title" className={styles.title}>Cookie Preferences</p>`
    - `<p id="cookie-banner-desc" className={styles.description}>We use reCAPTCHA and FingerprintJS to prevent spam on our contact form. These services may set cookies on your device. You can accept or decline their use.</p>`
  - Actions div (`styles.actions`):
    - Accept button: `ref={acceptButtonRef}`, `className={styles.actionButton}`, `onClick={() => setConsent(true)}`, text "Accept All"
    - Reject button: `className={styles.actionButton}`, `onClick={() => setConsent(false)}`, text "Reject All"
    - BOTH buttons use the SAME `styles.actionButton` class — identical visual treatment per ICO equal-prominence rules

**CookieBanner.module.css** — Fixed bottom bar with WCAG-compliant colors:
- `.banner`: `position: fixed; bottom: 0; left: 0; right: 0; z-index: 1000` (below react-toastify 9999). Background `#1E1E1F` (matches footer near-black), color `#FCFCFC` (16.24:1 contrast PASSES AA). Padding `1rem 2rem`, flexbox row, `align-items: center`, `justify-content: space-between`, `gap: 1rem`. Box shadow `0 -2px 12px rgba(0, 0, 0, 0.4)`.
- `.content`: `flex: 1; display: flex; flex-direction: column; gap: 0.25rem`
- `.title`: `font-size: 1rem; font-weight: 600; margin: 0; color: #FCFCFC`
- `.description`: `font-size: 0.875rem; margin: 0; color: #C6C6C6` (9.75:1 on #1E1E1F PASSES AA), `line-height: 1.5`
- `.actions`: `display: flex; gap: 0.75rem; flex-shrink: 0`
- `.actionButton`: `background-color: #ED6A00` (brand orange), `color: #1E1E1F` (5.28:1 contrast PASSES AA — do NOT use white text on orange as it fails at 3.07:1). `border: none; padding: 0.75rem 1.5rem; font-size: 1rem; font-weight: 600; border-radius: 4px; cursor: pointer; min-height: 44px` (exceeds WCAG 2.5.8 24px minimum), `min-width: 100px; white-space: nowrap; transition: opacity 0.15s ease; font-family: inherit`
- `.actionButton:hover`: `opacity: 0.85`
- `.actionButton:focus-visible`: `outline: 3px solid #FCFCFC; outline-offset: 2px` (visible focus indicator for WCAG 2.4.11/2.4.12)
- Mobile breakpoint `@media (max-width: 640px)`: `.banner` switches to `flex-direction: column; align-items: flex-start; padding: 1rem`. `.actions` gets `width: 100%; justify-content: stretch`. `.actionButton` gets `flex: 1` so buttons fill width equally.

**index.ts** — Simple re-export:
```typescript
export { default } from './CookieBanner';
```

**layout.tsx** — Add CookieBanner import and render:
- Add `import CookieBanner from '@/components/CookieBanner';` to imports
- Render `<CookieBanner />` inside `<body>` AFTER the closing `</Providers>` tag (before `</body>`). The banner reads Zustand store directly (module singleton), no provider wrapping needed.
  </action>
  <verify>
Run `npm run lint` — must pass with no errors.
Run `npm run build` — must compile successfully with no TypeScript or build errors.
Verify file structure: `ls src/components/CookieBanner/` shows CookieBanner.tsx, CookieBanner.module.css, index.ts.
Verify layout.tsx contains CookieBanner import and render.
  </verify>
  <done>
CookieBanner component exists with hydration guard, focus management, scroll-padding-bottom, Escape key dismissal, ARIA attributes, equal-prominence buttons, WCAG-compliant colors, and responsive mobile breakpoint. Root layout renders CookieBanner in body. Lint and build pass.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add Cookie Preferences button to Footer</name>
  <files>
    src/components/Footer/CookiePrefsButton.tsx
    src/components/Footer/Footer.tsx
    src/components/Footer/Footer.module.css
  </files>
  <action>
Create a small extracted client component for the Cookie Preferences button and integrate it into the existing server-rendered Footer. Do NOT add `'use client'` to Footer.tsx — keep it as a server component and import the client component as a child.

**CookiePrefsButton.tsx** — Extracted client component inside Footer folder:
- `'use client'` directive at top
- Import `useConsentStore` from `@/store/consentStore`
- Import `styles` from `./Footer.module.css`
- Default export function `CookiePrefsButton`
- Renders a `<button>` with `onClick` calling `clearConsent` from the consent store
- `className={styles.cookiePrefsButton}`
- Button text: "Cookie Preferences"
- The button should be styled to look like the existing footer links (text-styled, no background, matching color/size)

**Footer.module.css** — Add `.cookiePrefsButton` style:
- Match existing `.link` style: `color: #C6C6C6; font-size: 0.875rem; transition: color 0.2s ease`
- Remove button chrome: `background: none; border: none; padding: 0; cursor: pointer; font-family: inherit; text-align: left`
- Hover: `color: #ED6A00` (matching `.link:hover`)
- Add responsive overrides inside existing media queries: at 768px, match `.link` sizing (`font-size: 0.8125rem; padding: 0.25rem 0; display: block`). At 480px, match `.link` sizing (`font-size: 0.75rem`).

**Footer.tsx** — Add CookiePrefsButton to Legal column:
- Add import: `import CookiePrefsButton from './CookiePrefsButton';`
- In the Legal column div (the one containing Terms of Service, Privacy Policy, Delete My Data), add `<CookiePrefsButton />` as the last item after the "Delete My Data" link
- Do NOT add `'use client'` to Footer.tsx — a server component can import and render a client component child
  </action>
  <verify>
Run `npm run lint` — must pass with no errors.
Run `npm run build` — must compile successfully.
Verify Footer.tsx imports CookiePrefsButton and renders it in the Legal column.
Verify Footer.tsx does NOT have `'use client'` directive.
Verify CookiePrefsButton.tsx HAS `'use client'` directive and imports useConsentStore.
  </verify>
  <done>
Footer Legal column shows "Cookie Preferences" button styled identically to existing footer links. Clicking it calls clearConsent() which resets hasConsented to null, causing CookieBanner to reappear. Footer remains a server component. Lint and build pass.
  </done>
</task>

</tasks>

<verification>
After both tasks complete:
1. `npm run lint` passes with zero errors
2. `npm run build` compiles successfully
3. All 7 files exist and contain expected content:
   - `src/components/CookieBanner/CookieBanner.tsx` — uses useConsentStore, has role="dialog", aria-modal="false"
   - `src/components/CookieBanner/CookieBanner.module.css` — has .banner with position:fixed, .actionButton with #ED6A00 bg and #1E1E1F color
   - `src/components/CookieBanner/index.ts` — re-exports default
   - `src/app/layout.tsx` — imports and renders CookieBanner
   - `src/components/Footer/CookiePrefsButton.tsx` — 'use client', calls clearConsent
   - `src/components/Footer/Footer.tsx` — imports CookiePrefsButton, no 'use client'
   - `src/components/Footer/Footer.module.css` — has .cookiePrefsButton style
4. CookieBanner renders only when isHydrated=true AND hasConsented===null AND not dismissed
5. Both Accept All and Reject All buttons use same CSS class (equal prominence)
6. Escape key dismisses banner without recording consent (banner returns next visit)
7. Focus moves to Accept button on mount
8. scroll-padding-bottom is applied while banner is visible
</verification>

<success_criteria>
- Cookie consent banner appears at bottom of page on first visit (hasConsented is null)
- Banner disappears after clicking Accept All (hasConsented = true) or Reject All (hasConsented = false)
- Banner does not reappear after refresh (consent persisted in localStorage)
- Both buttons have identical visual styling
- Keyboard navigation works: Tab cycles through buttons, Enter activates, Escape dismisses
- Banner stacks vertically on mobile (640px breakpoint)
- Footer shows "Cookie Preferences" that resets consent and shows banner again
- Footer remains a server component
- All text passes WCAG 2.2 AA contrast (4.5:1 minimum)
- No hydration mismatch errors in browser console
- Lint and build pass clean
</success_criteria>

<output>
After completion, create `.planning/phases/02-banner-ui-user-controls/02-01-SUMMARY.md`
</output>
